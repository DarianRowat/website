<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tracker - Darian Rowat</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              bg: '#0B0C10',
              panel: '#1F2833',
              accent: '#45A29E',
              highlight: '#66FCF1',
              text: '#C5C6C7',
            },
            fontFamily: {
              hacked: ['Hacked', 'ui-sans-serif', 'system-ui', 'sans-serif'],
            },
          },
        },
      };
    </script>

    <link rel="stylesheet" href="assets/site.css" />
  </head>

  <body class="bg-bg text-text">
    <div class="relative min-h-screen">
      <div class="absolute inset-0 bg-[url('assets/circuit5.png')] bg-cover bg-center"></div>
      <div class="absolute inset-0 bg-black/70"></div>

      <div class="relative flex min-h-screen flex-col">
        <div id="site-header"></div>
        <div id="site-nav"></div>

        <main class="flex-1">
          <div class="mx-auto max-w-5xl px-4 py-10">
            <div class="rounded-2xl border border-highlight/15 bg-panel/60 p-6 shadow-xl backdrop-blur sm:p-8">
              <div class="flex flex-col gap-2 sm:flex-row sm:items-end sm:justify-between">
                <div>
                  <h2 class="text-3xl font-bold tracking-tight text-highlight sm:text-4xl">NSID Amount Tracker</h2>
                  <p class="mt-2 text-sm text-text/85">
                    Demo tool: track amounts per NSID, keep it in your browser (localStorage), and export CSV.
                  </p>
                </div>

                <div class="flex gap-2">
                  <button
                    id="exportBtn"
                    class="inline-flex items-center justify-center rounded-md bg-accent px-4 py-2 text-sm font-semibold text-bg shadow transition hover:bg-highlight hover:text-panel"
                  >
                    Export CSV
                  </button>
                  <button
                    id="clearBtn"
                    class="inline-flex items-center justify-center rounded-md border border-highlight/20 bg-bg/30 px-4 py-2 text-sm font-semibold text-text shadow transition hover:border-highlight/40 hover:bg-bg/50"
                  >
                    Clear
                  </button>
                </div>
              </div>

              <div class="mt-6 grid gap-6 lg:grid-cols-2">
                <form id="entryForm" class="rounded-xl border border-highlight/10 bg-bg/40 p-5">
                  <div class="text-sm font-semibold text-highlight">Add entry</div>

                  <div class="mt-4 grid gap-4 sm:grid-cols-2">
                    <div>
                      <label class="block text-sm text-text/80" for="nsid">NSID</label>
                      <input
                        type="text"
                        id="nsid"
                        required
                        placeholder="ddr271"
                        class="mt-1 w-full rounded-lg border border-highlight/15 bg-panel/50 px-3 py-2 text-sm text-text placeholder:text-text/40 outline-none focus:border-highlight/50 focus:ring-2 focus:ring-highlight/30"
                      />
                    </div>
                    <div>
                      <label class="block text-sm text-text/80" for="amount">Amount ($)</label>
                      <input
                        type="number"
                        id="amount"
                        step="0.01"
                        min="0"
                        required
                        placeholder="10.00"
                        class="mt-1 w-full rounded-lg border border-highlight/15 bg-panel/50 px-3 py-2 text-sm text-text placeholder:text-text/40 outline-none focus:border-highlight/50 focus:ring-2 focus:ring-highlight/30"
                      />
                    </div>
                    <div>
                      <label class="block text-sm text-text/80" for="firstName">First name</label>
                      <input
                        type="text"
                        id="firstName"
                        required
                        placeholder="Darian"
                        class="mt-1 w-full rounded-lg border border-highlight/15 bg-panel/50 px-3 py-2 text-sm text-text placeholder:text-text/40 outline-none focus:border-highlight/50 focus:ring-2 focus:ring-highlight/30"
                      />
                    </div>
                    <div>
                      <label class="block text-sm text-text/80" for="lastName">Last name</label>
                      <input
                        type="text"
                        id="lastName"
                        required
                        placeholder="Rowat"
                        class="mt-1 w-full rounded-lg border border-highlight/15 bg-panel/50 px-3 py-2 text-sm text-text placeholder:text-text/40 outline-none focus:border-highlight/50 focus:ring-2 focus:ring-highlight/30"
                      />
                    </div>
                  </div>

                  <button
                    type="submit"
                    class="mt-4 inline-flex items-center justify-center rounded-md bg-accent px-4 py-2 text-sm font-semibold text-bg shadow transition hover:bg-highlight hover:text-panel"
                  >
                    Add
                  </button>

                  <div class="mt-4 rounded-lg border border-highlight/10 bg-panel/40 p-4">
                    <div class="text-xs font-semibold uppercase tracking-wide text-text/70">Total owed (by NSID)</div>
                    <div id="owedAmount" class="mt-1 text-2xl font-bold text-highlight">$0.00</div>
                    <div id="owedMeta" class="mt-1 text-xs text-text/70">—</div>
                  </div>
                </form>

                <div class="rounded-xl border border-highlight/10 bg-bg/40 p-5">
                  <div class="flex items-center justify-between">
                    <div class="text-sm font-semibold text-highlight">Entries</div>
                    <div class="text-xs text-text/70" id="countMeta">0 entries</div>
                  </div>

                  <div class="mt-4 overflow-auto rounded-lg border border-highlight/10">
                    <table class="min-w-full text-left text-sm">
                      <thead class="bg-panel/70 text-text/80">
                        <tr>
                          <th class="px-3 py-2">NSID</th>
                          <th class="px-3 py-2">Name</th>
                          <th class="px-3 py-2">Amount</th>
                          <th class="px-3 py-2"></th>
                        </tr>
                      </thead>
                      <tbody id="entriesBody" class="divide-y divide-highlight/10 bg-bg/20"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>

        <div id="site-footer"></div>
      </div>
    </div>

    <script src="assets/site.js"></script>
    <script>
      const STORAGE_KEY = 'nsid_tracker_entries_v1';
      let data = [];

      function load() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          data = raw ? JSON.parse(raw) : [];
          if (!Array.isArray(data)) data = [];
        } catch {
          data = [];
        }
      }

      function save() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }

      function money(n) {
        return `$${Number(n || 0).toFixed(2)}`;
      }

      function totalForNsid(nsid) {
        return data
          .filter((e) => e.nsid.toLowerCase() === nsid.toLowerCase())
          .reduce((sum, e) => sum + Number(e.amount || 0), 0);
      }

      function renderEntries() {
        const body = document.getElementById('entriesBody');
        const countMeta = document.getElementById('countMeta');
        body.innerHTML = '';

        data.forEach((e, idx) => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-bg/40';
          tr.innerHTML = `
            <td class="px-3 py-2 font-mono text-xs text-text/80">${escapeHtml(e.nsid)}</td>
            <td class="px-3 py-2 text-text/90">${escapeHtml(e.firstName)} ${escapeHtml(e.lastName)}</td>
            <td class="px-3 py-2 font-semibold text-highlight">${money(e.amount)}</td>
            <td class="px-3 py-2 text-right">
              <button
                class="rounded-md border border-highlight/15 bg-panel/50 px-2 py-1 text-xs text-text/80 hover:border-highlight/35 hover:text-text"
                data-del="${idx}"
                title="Delete entry"
              >
                Delete
              </button>
            </td>
          `;
          body.appendChild(tr);
        });

        countMeta.textContent = `${data.length} ${data.length === 1 ? 'entry' : 'entries'}`;
      }

      function updateOwed() {
        const nsid = document.getElementById('nsid').value.trim();
        const owedAmount = document.getElementById('owedAmount');
        const owedMeta = document.getElementById('owedMeta');

        if (!nsid) {
          owedAmount.textContent = '$0.00';
          owedMeta.textContent = '—';
          return;
        }

        const total = totalForNsid(nsid);
        owedAmount.textContent = money(total);
        owedMeta.textContent = `Showing total for ${nsid}`;
      }

      function exportCSV() {
        const header = ['NSID', 'First Name', 'Last Name', 'Amount'];
        const rows = data.map((e) => [e.nsid, e.firstName, e.lastName, e.amount]);
        const csv = [header, ...rows]
          .map((r) => r.map((x) => '"' + String(x ?? '').replaceAll('"', '""') + '"').join(','))
          .join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'data.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function escapeHtml(s) {
        return String(s ?? '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      // Boot
      load();
      renderEntries();
      updateOwed();

      document.getElementById('entryForm').addEventListener('submit', (event) => {
        event.preventDefault();

        const nsid = document.getElementById('nsid').value.trim();
        const firstName = document.getElementById('firstName').value.trim();
        const lastName = document.getElementById('lastName').value.trim();
        const amount = Number(document.getElementById('amount').value);

        if (!nsid || !firstName || !lastName || !Number.isFinite(amount) || amount <= 0) {
          alert('Please enter a valid NSID, name, and a positive amount.');
          return;
        }

        data.push({ nsid, firstName, lastName, amount });
        save();
        renderEntries();
        updateOwed();
        document.getElementById('amount').value = '';
      });

      document.getElementById('nsid').addEventListener('input', updateOwed);

      document.getElementById('entriesBody').addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-del]');
        if (!btn) return;
        const idx = Number(btn.getAttribute('data-del'));
        if (!Number.isInteger(idx)) return;
        data.splice(idx, 1);
        save();
        renderEntries();
        updateOwed();
      });

      document.getElementById('exportBtn').addEventListener('click', () => {
        exportCSV();
      });

      document.getElementById('clearBtn').addEventListener('click', () => {
        if (!confirm('Clear all saved entries?')) return;
        data = [];
        save();
        renderEntries();
        updateOwed();
      });
    </script>
  </body>
</html>
